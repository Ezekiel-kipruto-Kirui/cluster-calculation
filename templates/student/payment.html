{% extends "base.html" %}

{% block title %}Pay with M-Pesa{% endblock %}

{% block top_actions %}
<a href="{{ url_for('main.home') }}" class="rounded-md px-3 py-2 text-slate-700 transition hover:bg-slate-100">
    Home
</a>
<a href="{{ url_for('main.calculator') }}" class="rounded-md px-3 py-2 text-slate-700 transition hover:bg-slate-100">
    Calculator
</a>
{% endblock %}

{% block content %}
<section class="mx-auto max-w-2xl space-y-6">
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
        <h1 class="text-2xl font-semibold tracking-tight text-slate-900">Complete Payment</h1>
        <p class="mt-2 text-sm text-slate-600">
            Pay <span class="font-semibold text-slate-900">KES {{ amount }}</span> using M-Pesa to continue with cluster point calculation.
        </p>

        {% if error %}
        <div class="mt-4 rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700">
            {{ error }}
        </div>
        {% endif %}

        {% if info %}
        <div class="mt-4 rounded-md border border-emerald-200 bg-emerald-50 px-3 py-2 text-sm text-emerald-700">
            {{ info }}
        </div>
        {% endif %}

        {% if not mpesa_enabled %}
        <div class="mt-4 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800">
            M-Pesa payments are disabled on this server.
        </div>
        {% elif not mpesa_ready %}
        <div class="mt-4 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800">
            M-Pesa credentials are not complete. Configure Daraja settings in environment variables.
        </div>
        {% endif %}

        <form action="{{ url_for('main.initiate_payment') }}" method="post" class="mt-6 space-y-4">
            <div>
                <label for="phone_number" class="mb-1 block text-sm font-medium text-slate-700">M-Pesa Phone Number</label>
                <input
                    id="phone_number"
                    name="phone_number"
                    type="tel"
                    value="{{ phone_number }}"
                    placeholder="0712345678"
                    required
                    class="block w-full rounded-md border-slate-300 text-slate-900 shadow-sm focus:border-slate-500 focus:ring-slate-500"
                >
                <p class="mt-1 text-xs text-slate-500">Use Safaricom format: 07XXXXXXXX or 2547XXXXXXXX.</p>
            </div>

            <button
                type="submit"
                {% if not mpesa_enabled or not mpesa_ready %}disabled{% endif %}
                class="inline-flex items-center justify-center rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition enabled:hover:bg-slate-800 disabled:cursor-not-allowed disabled:bg-slate-400"
            >
                Send STK Push
            </button>
        </form>
    </div>

    {% if payment %}
    <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Payment Status</h2>
        <dl class="mt-3 space-y-2 text-sm text-slate-700">
            <div>
                <dt class="font-medium text-slate-900">Checkout Request ID</dt>
                <dd class="break-all">{{ payment.checkout_request_id }}</dd>
            </div>
            <div>
                <dt class="font-medium text-slate-900">Current Status</dt>
                <dd>{{ payment.status }}</dd>
            </div>
            {% if payment.result_desc %}
            <div>
                <dt class="font-medium text-slate-900">Message</dt>
                <dd>{{ payment.result_desc }}</dd>
            </div>
            {% endif %}
            {% if payment.mpesa_receipt %}
            <div>
                <dt class="font-medium text-slate-900">Receipt</dt>
                <dd>{{ payment.mpesa_receipt }}</dd>
            </div>
            {% endif %}
        </dl>

        <div class="mt-4 flex flex-wrap items-center gap-3">
            <a
                href="{{ url_for('main.payment_page') }}"
                class="inline-flex items-center rounded-md border border-slate-300 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-100"
            >
                Refresh Status
            </a>
            <a
                href="{{ url_for('main.continue_after_payment') }}"
                class="inline-flex items-center rounded-md bg-emerald-700 px-3 py-2 text-xs font-semibold text-white transition hover:bg-emerald-800"
            >
                Continue to Results
            </a>
        </div>
    </div>
    {% endif %}
</section>
{% endblock %}
